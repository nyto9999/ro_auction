import pandas as pd
import plotly.graph_objects as go
from plotly.subplots import make_subplots
import os
import numpy as np 
from datetime import timedelta

# --- 1. é…ç½®èˆ‡æ•¸æ“šè¼‰å…¥ (èˆ‡ä¸Šæ¬¡ç›¸åŒ) ---

CSV_FILE = "ç¥ä¹‹é‡‘å±¬.csv"
ITEM_NAME_TO_PLOT = "ç¥ä¹‹é‡‘å±¬" 
DATE_FORMAT = '%Y-%m-%dT%H:%M:%S.%f' 

def load_and_preprocess_data(file_path):
    """è¼‰å…¥ CSV æª”æ¡ˆï¼Œæ¸…ç†æ•¸æ“šä¸¦é€²è¡Œé è™•ç†ã€‚"""
    if not os.path.exists(file_path):
        print(f"éŒ¯èª¤: æ‰¾ä¸åˆ°æª”æ¡ˆ {file_path}ã€‚ä½¿ç”¨æ¨¡æ“¬æ•¸æ“šé€²è¡Œç¤ºç¯„ã€‚")
        data = {
            'timestamp': [
                (pd.to_datetime('2025-09-25 00:00:00') + timedelta(hours=i)).strftime(DATE_FORMAT) 
                for i in range(1, 100)] + [(pd.to_datetime('2025-09-25 00:00:00') + timedelta(hours=i)).strftime(DATE_FORMAT) for i in range(1, 100)],
            'item_name': [ITEM_NAME_TO_PLOT] * 198,
            'trade_type': ['æ”¶è³¼', 'è²©å”®'] * 99,
            'price': np.random.randint(8000, 15000, 198),
            'quantity': np.random.randint(5, 300, 198)
        }
        df = pd.DataFrame(data)
    else:
        try:
            df = pd.read_csv(file_path, dtype={'timestamp': str})
        except Exception as e:
            print(f"éŒ¯èª¤: è®€å– CSV æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")
            return None

    df = df[df['item_name'] == ITEM_NAME_TO_PLOT].copy()
    if df.empty:
        print(f"éŒ¯èª¤: åœ¨æª”æ¡ˆä¸­æ‰¾ä¸åˆ°é“å…·ã€{ITEM_NAME_TO_PLOT}ã€‘çš„æ•¸æ“šã€‚")
        return None
    
    try:
        df['timestamp'] = pd.to_datetime(df['timestamp'], format=DATE_FORMAT)
    except Exception as e:
        print(f"éŒ¯èª¤: æ™‚é–“æˆ³æ ¼å¼ä¸æ­£ç¢ºï¼Œç„¡æ³•è§£æ ({DATE_FORMAT})ã€‚éŒ¯èª¤è¨Šæ¯: {e}")
        return None
    
    df['hour'] = df['timestamp'].dt.to_period('H').dt.to_timestamp()
    
    summary_df = generate_summary(df) 
    
    return summary_df

def generate_summary(df):
    """è¨ˆç®—å°æ™‚ç´šåˆ¥çš„åƒ¹æ ¼çµ±è¨ˆã€æ•¸é‡ï¼Œä¸å†è¨ˆç®— MAã€‚"""
    
    price_summary = df.groupby(['hour', 'trade_type'])['price'].agg(['min', 'max']).unstack(level='trade_type')
    price_summary.columns = [f'{agg}_{trade_type}' for agg, trade_type in price_summary.columns]
    
    volume_summary = df.groupby(['hour', 'trade_type'])['quantity'].sum().unstack(level='trade_type')
    volume_summary.columns = [f'volume_{trade_type}' for trade_type in volume_summary.columns]
    
    combined_df = price_summary.join(volume_summary, how='outer')
    
    if combined_df.empty:
        return pd.DataFrame()

    combined_df = combined_df.resample('H').asfreq() 
    
    required_price_cols = ['min_æ”¶è³¼', 'max_æ”¶è³¼', 'min_è²©å”®', 'max_è²©å”®']
    required_volume_cols = ['volume_æ”¶è³¼', 'volume_è²©å”®']
    
    for col in required_price_cols + required_volume_cols:
        if col not in combined_df.columns:
            if 'volume' in col:
                combined_df[col] = 0
            else:
                combined_df[col] = np.nan
            
    combined_df[required_volume_cols] = combined_df[required_volume_cols].fillna(0)
    
    combined_df[required_price_cols] = combined_df[required_price_cols].ffill()
    
    combined_df = combined_df.sort_index()
    
    return combined_df

# --- 2. ç¹ªåœ–é‚è¼¯ (ç§»é™¤ MA åŠŸèƒ½èˆ‡æŒ‰éˆ•ï¼Œèª¿æ•´è¨»é‡‹ä½ç½®) ---

def plot_combined_trends_plotly(summary_df, item_name):
    """ä½¿ç”¨ Plotly ç¹ªè£½ä¸‰å­åœ–ï¼Œç§»é™¤ MA ç·šå’Œæ§åˆ¶æŒ‰éˆ•ï¼Œå°‡ Trace ç´¢å¼•è¨»é‡‹æ”¾ç½®åœ¨åœ–è¡¨å³ä¸‹æ–¹ã€‚"""
    
    # å‰µå»º 3 è¡Œ 1 åˆ—çš„å­åœ–ï¼Œå…±ç”¨ X è»¸
    fig = make_subplots(
        rows=3, cols=1, 
        shared_xaxes=True, 
        vertical_spacing=0.1, 
        subplot_titles=(
            f'ã€æ”¶è³¼ã€‘åƒ¹æ ¼è¶¨å‹¢ (Max Buy Price)', 
            f'ã€è²©å”®ã€‘åƒ¹æ ¼è¶¨å‹¢ (Min Sell Price)',
            'å°æ™‚ç¸½æ•¸é‡è¶¨å‹¢ (æˆäº¤é‡)'
        ),
        specs=[[{"secondary_y": False}], [{"secondary_y": False}], [{"secondary_y": False, "rowspan": 1}]]
    )
    
    # ****** é¡è‰²å®šç¾© ******
    COLOR_BUY_MAX = '#2E7D32'      # æ·±ç¶ 
    COLOR_BUY_MIN = '#66BB6A'      # æ·ºç¶ 
    COLOR_SELL_MIN = '#C62828'     # æ·±ç´…
    COLOR_SELL_MAX = '#E57373'     # æ·ºç´…
    
    line_config = lambda color, dash: dict(
        mode='lines', line=dict(color=color, dash=dash, shape='spline', width=3) 
    )
    
    # ====== Trace ç´¢å¼•é…ç½® (ç²¾ç°¡å¾Œï¼Œå°æ‡‰ Trace 0-5) ======
    TRACE_INDEX_CONFIG = """
    **Trace ç´¢å¼•é…ç½®**
    
    **Row 1 (æ”¶è³¼åƒ¹):**
    0: æ”¶è³¼æœ€é«˜åƒ¹ (Max Buy)
    1: æ”¶è³¼æœ€ä½åƒ¹ (Min Buy)
    
    **Row 2 (è²©å”®åƒ¹):**
    2: è²©å”®æœ€ä½åƒ¹ (Min Sell)
    3: è²©å”®æœ€é«˜åƒ¹ (Max Sell)
    
    **Row 3 (æˆäº¤é‡):**
    4: æ”¶è³¼æ•¸é‡ (Volume Buy)
    5: è²©å”®æ•¸é‡ (Volume Sell)
    """
    
    # ----------------------------------------------------
    # ====== Row 1: æ”¶è³¼åƒ¹æ ¼ (Max Buy Price) ======
    # ----------------------------------------------------
    
    # Trace 0-1: åƒ¹æ ¼ç·š (Prices)
    fig.add_trace(go.Scatter(x=summary_df.index, y=summary_df['max_æ”¶è³¼'], name='æ”¶è³¼æœ€é«˜åƒ¹ (Max Buy)', **line_config(COLOR_BUY_MAX, 'solid')), row=1, col=1)
    fig.add_trace(go.Scatter(x=summary_df.index, y=summary_df['min_æ”¶è³¼'], name='æ”¶è³¼æœ€ä½åƒ¹ (Min Buy)', **line_config(COLOR_BUY_MIN, 'dot')), row=1, col=1) 

    fig.update_yaxes(title_text='æ”¶è³¼åƒ¹æ ¼ (Zeny)', row=1, col=1, tickformat=',.0f', fixedrange=False, gridcolor='#E0E0E0', title_font=dict(size=14)) 
    
    
    # ----------------------------------------------------
    # ====== Row 2: è²©å”®åƒ¹æ ¼ (Min Sell Price) ======
    # ----------------------------------------------------
    
    # Trace 2-3: åƒ¹æ ¼ç·š (Prices)
    fig.add_trace(go.Scatter(x=summary_df.index, y=summary_df['min_è²©å”®'], name='è²©å”®æœ€ä½åƒ¹ (Min Sell)', **line_config(COLOR_SELL_MIN, 'solid')), row=2, col=1)
    fig.add_trace(go.Scatter(x=summary_df.index, y=summary_df['max_è²©å”®'], name='è²©å”®æœ€é«˜åƒ¹ (Max Sell)', **line_config(COLOR_SELL_MAX, 'dot')), row=2, col=1) 

    fig.update_yaxes(title_text='è²©å”®åƒ¹æ ¼ (Zeny)', row=2, col=1, tickformat=',.0f', fixedrange=False, gridcolor='#E0E0E0', title_font=dict(size=14))
    
    
    # ----------------------------------------------------
    # ====== Row 3: æ•¸é‡å †ç–ŠæŸ±ç‹€åœ– (Volume) ======
    # ----------------------------------------------------
    
    # Trace 4-5: æ•¸é‡æŸ± (Volume Bars)
    fig.add_trace(go.Bar(
        x=summary_df.index, y=summary_df['volume_æ”¶è³¼'], name='æ”¶è³¼æ•¸é‡ (Buy)', marker_color=COLOR_BUY_MAX,
        hovertemplate='<b>æ™‚é–“:</b> %{x|%m/%d %H:%M}<br><b>æ”¶è³¼æ•¸é‡:</b> %{y:,} å€‹<extra></extra>'), 
        row=3, col=1) 
    
    fig.add_trace(go.Bar(
        x=summary_df.index, y=summary_df['volume_è²©å”®'], name='è²©å”®æ•¸é‡ (Sell)', marker_color=COLOR_SELL_MIN,
        hovertemplate='<b>æ™‚é–“:</b> %{x|%m/%d %H:%M}<br><b>è²©å”®æ•¸é‡:</b> %{y:,} å€‹<extra></extra>'), 
        row=3, col=1) 
    
    fig.update_layout(barmode='stack')
    
    fig.update_yaxes(title_text='ç¸½æ•¸é‡ (Volume)', row=3, col=1, tickformat=',.0f', fixedrange=True, gridcolor='#E0E0E0', title_font=dict(size=14))


    # ----------------------------------------------------
    # ====== ç¸½é«”ä½ˆå±€èˆ‡äº’å‹•æ€§è¨­ç½® (Range Selector & Annotation) ======
    # ----------------------------------------------------
    
    # Range Selector/Slider (æ”¾åœ¨ Row 3 çš„ X è»¸ä¸Š)
    time_controls = dict(
        rangeslider=dict(visible=True, thickness=0.08), 
        rangeselector=dict(
            buttons=list([
                dict(count=1, label="1å°æ™‚", step="hour", stepmode="backward"), 
                dict(count=1, label="1å¤©", step="day", stepmode="backward"),
                dict(count=7, label="7å¤©", step="day", stepmode="backward"),
                dict(step="all")
            ])
        )
    )
    
    # ğŸŒŸ èª¿æ•´ Trace ç´¢å¼•è¨»é‡‹ä½ç½®åˆ°å³ä¸‹æ–¹ ğŸŒŸ
    annotations = [
        dict(
            text=TRACE_INDEX_CONFIG.strip(),
            xref="paper", yref="paper",
            x=1.05, y=0.1, # X=1.05 (å³å´), Y=0.1 (æ¥è¿‘åº•éƒ¨)
            xanchor='left', yanchor='bottom', # ç¢ºä¿æ–‡å­—å¾å·¦ä¸‹æ–¹é–‹å§‹å»¶ä¼¸
            showarrow=False,
            align='left',
            bordercolor='#9C9C9C', borderwidth=1, borderpad=10,
            bgcolor='#f9f9f9', opacity=0.8,
            font=dict(size=10, family="Courier New, monospace")
        )
    ]


    fig.update_layout(
        template='plotly_white', 
        font=dict(family="Arial, sans-serif", size=12, color="black"),
        title_text=f'**{item_name}** å¸‚å ´åˆ†æè¶¨å‹¢ (ç²¾ç°¡ç‰ˆ - ç„¡ MA)',
        title_x=0.5,
        height=900, 
        hovermode="x unified",
        
        # èª¿æ•´åœ–è¡¨ç¹ªè£½å€åŸŸä»¥é¨°å‡ºå³å´ç©ºé–“çµ¦ Annotation
        margin=dict(r=150), 
        
        annotations=annotations, # åŠ å…¥è¨»é‡‹
        
        # **updatemenus (MA æŒ‰éˆ•) å·²ç§»é™¤**
        
        legend=dict(
            orientation="h", yanchor="bottom", y=1.0, xanchor="center", x=0.5, traceorder='normal'
        ),
        
        xaxis1=dict(
            matches='x3', showticklabels=False, fixedrange=True, showgrid=False
        ),
        xaxis2=dict(
            matches='x3', showticklabels=False, fixedrange=True, showgrid=False
        ),
        xaxis3={
            **time_controls, # æ”¾ç½® Range Selector å’Œ Slider
            **dict(
                showticklabels=True, fixedrange=True, showgrid=False
            )
        } 
    )
    
    fig.show()

# --- 3. ä¸»åŸ·è¡Œæµç¨‹ (ä¿æŒä¸è®Š) ---

def main():
    """ä¸»å‡½å¼ï¼šè¼‰å…¥ã€è™•ç†ä¸¦ç¹ªè£½æ•¸æ“šã€‚"""
    print(f"ğŸ“Š æ­£åœ¨æº–å‚™ç¹ªè£½ã€{ITEM_NAME_TO_PLOT}ã€‘çš„ Plotly äº’å‹•å¼è¶¨å‹¢åœ– (ç²¾ç°¡ç‰ˆ)...")
    
    summary_df = load_and_preprocess_data(CSV_FILE)
    
    if summary_df is None or summary_df.empty:
        print("è­¦å‘Š: æ•¸æ“šç‚ºç©ºæˆ–è™•ç†å¤±æ•—ã€‚")
        return
        
    print(f"âœ… æ•¸æ“šè™•ç†å®Œæˆï¼Œå…±æœ‰ {len(summary_df)} å€‹å°æ™‚çš„æ•¸æ“šé»ã€‚")
    
    plot_combined_trends_plotly(summary_df, ITEM_NAME_TO_PLOT)
    
    print("\nğŸ‰ ç¹ªåœ–å®Œæˆã€‚åœ–è¡¨å·²ç²¾ç°¡ï¼Œç§»é™¤æ‰€æœ‰ MA ç·šåŠæ§åˆ¶æŒ‰éˆ•ï¼Œä¸¦å°‡ Trace ç´¢å¼•ç§»è‡³åœ–è¡¨å³ä¸‹æ–¹ã€‚")

if __name__ == "__main__":
    main()